machine:
  services:
    - docker
  environment:
    release: 0.4.${CIRCLE_BUILD_NUM}
  java:
    version: oraclejdk8
    
general:
  branches:
    ignore:
      - gh-pages

dependencies:
  cache_directories:
    - "~/docker"

  override:
      - sudo -H pip install docker-compose
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./build.sh

test:
  override:
    - docker-compose build && docker-compose up

deployment:
  staging:
      branch: staging
      commands:
        - git config --global user.email "hello@neilellis.me"
        - git config --global user.name "Neil Ellis"
        - git reset HEAD --hard
        - git clean -fd
        - git checkout master
        - git pull
        - git merge staging -m "Auto merge"
        - git push
        - echo ${release} > .release
        - envsubst < README.md > README.expanded
        - mv README.expanded README.md
        - 'git commit -a -m "Promotion from staging" || :'
        - "git tag ${release} || :"
        - git push --tags
        - git push origin master

  production:
      branch: master
      commands:
          - cd kong && docker build -t sillelien/dollarscript:$(cat .release) .
          - docker push sillelien/dollarscript:${release}
          - cd kong && docker build -t sillelien/dollarscript .
          - docker push sillelien/dollarscript


  development:
      branch: dev
      commands:
          - cd kong && docker build -t sillelien/dollarscript:dev .
          - docker push sillelien/dollarscript:dev
